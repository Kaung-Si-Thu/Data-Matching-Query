#CHECK matches for A CUSTOMER PROFILE AND B CUSTOMER PROFILE


#First QUERY
WITH 
_getCUSProifle AS (
  SELECT 
  CUSTOMER_ID, 
  CUSTOMER_ADDRESS, 
  CUSTOMER_MOBILE_1, CUSTOMER_MOBILE_2, CUSTOMER_MOBILE_3,
  CUSTOMER_ID,
  
  --Min(CUSTOMER_KYC_LAST_UPDATED_TIMESTAMP) AS CUSTOMER_KYC_LAST_UPDATED */
  
  FROM `BUSINESS_MARTS.CUSTOMER_PROFILE_COMBI` 
  WHERE DATE_KEY = DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY)
  AND IFNULL(IS_TEST, 0) = 0 AND IFNULL(IS_SYSTEM, 0) = 0
  AND CUSTOMER_STATUS = 'ACTIVE' 
  AND CUSTOMER_KYC_LEVEL = 2
  AND FLAG_WALLET_CUSTOMER = 1
  
)
,_getRCUSProfile AS (
  SELECT 
  CUSTOMER_ID, 
  IF(RIGHT(TRIM(CUSTOMER_FIRSTNAME),LENGTH(TRIM(CUSTOMER_LASTNAME)))=TRIM(CUSTOMER_LASTNAME),CUSTOMER_FIRSTNAME,
  IF(TRIM(CUSTOMER_FIRSTNAME)=TRIM(CUSTOMER_LASTNAME),TRIM(CUSTOMER_FIRSTNAME),CONCAT(TRIM(CUSTOMER_FIRSTNAME),'',IFNULL(CUSTOMER_LASTNAME,'')))) AS CUSTOMER_NAME,
  CUSTOMER_KYC_PRIMARY_IDENTITY_ID AS CUSTOMER_NRC,
  CUSTOMER_MOBILE_1, CUSTOMER_MOBILE_2, CUSTOMER_MOBILE_3
  FROM `RISK_MARTS.CUSTOMER_PROFILE_COMBI` 
  WHERE DATE_KEY = DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY)
  AND IFNULL(IS_TEST, 0) = 0 AND IFNULL(IS_SYSTEM, 0) = 0
  AND CUSTOMER_STATUS = 'ACTIVE' 
  AND CUSTOMER_KYC_LEVEL = 2
  --AND FLAG_WALLET_CUSTOMER = 1
)



,_min_date AS(
 SELECT CUSTOMER_ID, Min(CUSTOMER_KYC_LAST_UPDATED_TIMESTAMP) AS CUSTOMER_KYC_LAST_UPDATED
 FROM `BUSINESS_MARTS.CUSTOMER_PROFILE_STAGING` 
 Group by 1 
)


,_check_TMCUS AS ( 
SELECT DISTINCT 
      R.CUSTOMER_ID,
      M.Customer_Name,
      M.Contact_Number,
      M.NRC,
 


       
      
  CASE WHEN coalesce(R.CUSTOMER_ID) IS NOT NULL THEN 'TM Customers'
  ELSE 'Not TM Customers' END AS Flag_TM_Customers,
  /*
  CASE
          WHEN P.CUSTOMER_ID IS NOT NULL THEN DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY) 
          ELSE NULL
        END AS Match_Date
  */


FROM `BI_WORKSPACE.test_Customers` M
LEFT JOIN _getCUSProifle P ON  Contact_Number = CUSTOMER_MOBILE_1 Or Contact_Number =  CUSTOMER_MOBILE_2 Or Contact_Number =  CUSTOMER_MOBILE_3


LEFT JOIN _getRCUSProfile R ON UPPER(REGEXP_REPLACE(M.NRC, r'\([^)]*\)', '()')) = UPPER(REGEXP_REPLACE(R.CUSTOMER_NRC, r'\([^)]*\)', '()')) AND (Contact_Number =  R.CUSTOMER_MOBILE_1 Or Contact_Number =  R.CUSTOMER_MOBILE_2 Or Contact_Number =  R.CUSTOMER_MOBILE_3)
WHERE M.Flag_TM_Customers = "Not TM Customers" OR M.Flag_TM_Customers is null OR  M.Flag_TM_Customers = ""


 )


SELECT * 
FROM _check_TMCUS
WHERE Flag_TM_Customers = "TM Customers"
ORDER BY 1

Send to MAB for Matched customers by NRC and Mobile No.




2nd Query
Hard coding into MAB CUSTOMER Profile




MERGE `BI_WORKSPACE.test_MAB_Customers` AS target
USING `BI_WORKSPACE.vw_MAB_Customers_check` AS source
ON target.Contact_Number = source.Contact_Number AND target.NRC = source.NRC
WHEN MATCHED THEN
  UPDATE SET
    Flag_TM_Customers = source.Flag_TM_Customers;



3rd Query

WITH 
_getCUSProifle AS (
  SELECT 
  CUSTOMER_ID, 
  CUSTOMER_ADDRESS, 
  CUSTOMER_MOBILE_1, CUSTOMER_MOBILE_2, CUSTOMER_MOBILE_3,
  CUSTOMER_ID,
  
  --Min(CUSTOMER_KYC_LAST_UPDATED_TIMESTAMP) AS CUSTOMER_KYC_LAST_UPDATED */
  
  FROM `BUSINESS_MARTS.CUSTOMER_PROFILE_COMBI` 
  WHERE DATE_KEY = DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY)
  AND IFNULL(IS_TEST, 0) = 0 AND IFNULL(IS_SYSTEM, 0) = 0
  AND CUSTOMER_STATUS = 'ACTIVE' 
  AND CUSTOMER_KYC_LEVEL = 2
  AND FLAG_WALLET_CUSTOMER = 1
  
)
,_getRCUSProfile AS (
  SELECT 
  CUSTOMER_ID, 
  IF(RIGHT(TRIM(CUSTOMER_FIRSTNAME),LENGTH(TRIM(CUSTOMER_LASTNAME)))=TRIM(CUSTOMER_LASTNAME),CUSTOMER_FIRSTNAME,
  IF(TRIM(CUSTOMER_FIRSTNAME)=TRIM(CUSTOMER_LASTNAME),TRIM(CUSTOMER_FIRSTNAME),CONCAT(TRIM(CUSTOMER_FIRSTNAME),'',IFNULL(CUSTOMER_LASTNAME,'')))) AS CUSTOMER_NAME,
  CUSTOMER_KYC_PRIMARY_IDENTITY_ID AS CUSTOMER_NRC,
  CUSTOMER_MOBILE_1, CUSTOMER_MOBILE_2, CUSTOMER_MOBILE_3
  FROM `RISK_MARTS.CUSTOMER_PROFILE_COMBI` 
  WHERE DATE_KEY = DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY)
  AND IFNULL(IS_TEST, 0) = 0 AND IFNULL(IS_SYSTEM, 0) = 0
  AND CUSTOMER_STATUS = 'ACTIVE' 
  AND CUSTOMER_KYC_LEVEL = 2
  --AND FLAG_WALLET_CUSTOMER = 1
)



,_min_date AS(
 SELECT CUSTOMER_ID, Min(CUSTOMER_KYC_LAST_UPDATED_TIMESTAMP) AS CUSTOMER_KYC_LAST_UPDATED
 FROM `BUSINESS_MARTS.CUSTOMER_PROFILE_STAGING` 
 Group by 1 
)


,_check_TMCUS AS ( 
SELECT DISTINCT 
      R.CUSTOMER_ID,
      M.Customer_Name,
      M.Contact_Number,
      M.NRC,
 


       
      
  CASE WHEN coalesce(R.CUSTOMER_ID) IS NOT NULL THEN 'TM Customers By Mobile No.'
  ELSE 'Not TM Customers' END AS Flag_TM_Customers,
  /*
  CASE
          WHEN P.CUSTOMER_ID IS NOT NULL THEN DATE_SUB(CURRENT_DATE('Asia/Rangoon'), INTERVAL 1 DAY) 
          ELSE NULL
        END AS Match_Date
  */


FROM `BI_WORKSPACE.test_Customers` M
LEFT JOIN _getCUSProifle P ON  Contact_Number = CUSTOMER_MOBILE_1 Or Contact_Number =  CUSTOMER_MOBILE_2 Or Contact_Number =  CUSTOMER_MOBILE_3


LEFT JOIN _getRCUSProfile R ON (Contact_Number =  R.CUSTOMER_MOBILE_1 Or Contact_Number =  R.CUSTOMER_MOBILE_2 Or Contact_Number =  R.CUSTOMER_MOBILE_3)


WHERE M.Flag_TM_Customers = "Not TM Customers" OR M.Flag_TM_Customers is null OR  M.Flag_TM_Customers = ""


 )


SELECT * 
FROM _check_TMCUS
WHERE Flag_TM_Customers = "TM Customers By Mobile No."
ORDER BY 1

#4th Query
#Hard coding into B CUSTOMER Profile


MERGE `BI_WORKSPACE.test_Customers` AS target
USING `BI_WORKSPACE.vw_Customers_check_2` AS source
ON target.Contact_Number = source.Contact_Number AND target.NRC = source.NRC
WHEN MATCHED THEN
  UPDATE SET
    Flag_TM_Customers = source.Flag_TM_Customers;


#5th Query

Select Customer_Name,Contact_Number,NRC
  FROM `BI_WORKSPACE.test__Customers`
WHERE Flag_TM_Customers <> "TM Customers" AND Flag_TM_Customers <> " TM Customers By Mobile No."



